
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        #game-board {
            width: 450px;
            height: 450px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 3px;
            background: #000;
            padding: 3px;
            margin: 0 auto;
        }

        .game-cell {
            background: white;
        }

        .small-board {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 1px;
        }

        .cell {
            border: 1px solid #888;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            background: white;
            font-family: Arial, Helvetica, sans-serif;
        }

        .cell:hover {
            background: #f0f0f0;
        }

        .small-board.active .cell {
            background: #fffacd;
        }
    </style>
</head>
<body>
    <div id="game-board">
        <div class="game-cell">
            <div class="small-board" data-board="0">
                <div class="cell" data-board="0" data-cell="0"></div>
                <div class="cell" data-board="0" data-cell="1"></div>
                <div class="cell" data-board="0" data-cell="2"></div>
                <div class="cell" data-board="0" data-cell="3"></div>
                <div class="cell" data-board="0" data-cell="4"></div>
                <div class="cell" data-board="0" data-cell="5"></div>
                <div class="cell" data-board="0" data-cell="6"></div>
                <div class="cell" data-board="0" data-cell="7"></div>
                <div class="cell" data-board="0" data-cell="8"></div>
            </div>
        </div>
        <div class="game-cell">
            <div class="small-board" data-board="1">
                <div class="cell" data-board="1" data-cell="0"></div>
                <div class="cell" data-board="1" data-cell="1"></div>
                <div class="cell" data-board="1" data-cell="2"></div>
                <div class="cell" data-board="1" data-cell="3"></div>
                <div class="cell" data-board="1" data-cell="4"></div>
                <div class="cell" data-board="1" data-cell="5"></div>
                <div class="cell" data-board="1" data-cell="6"></div>
                <div class="cell" data-board="1" data-cell="7"></div>
                <div class="cell" data-board="1" data-cell="8"></div>
            </div>
        </div>
        <div class="game-cell">
            <div class="small-board" data-board="2">
                <div class="cell" data-board="2" data-cell="0"></div>
                <div class="cell" data-board="2" data-cell="1"></div>
                <div class="cell" data-board="2" data-cell="2"></div>
                <div class="cell" data-board="2" data-cell="3"></div>
                <div class="cell" data-board="2" data-cell="4"></div>
                <div class="cell" data-board="2" data-cell="5"></div>
                <div class="cell" data-board="2" data-cell="6"></div>
                <div class="cell" data-board="2" data-cell="7"></div>
                <div class="cell" data-board="2" data-cell="8"></div>
            </div>
        </div>
        <div class="game-cell">
            <div class="small-board" data-board="3">
                <div class="cell" data-board="3" data-cell="0"></div>
                <div class="cell" data-board="3" data-cell="1"></div>
                <div class="cell" data-board="3" data-cell="2"></div>
                <div class="cell" data-board="3" data-cell="3"></div>
                <div class="cell" data-board="3" data-cell="4"></div>
                <div class="cell" data-board="3" data-cell="5"></div>
                <div class="cell" data-board="3" data-cell="6"></div>
                <div class="cell" data-board="3" data-cell="7"></div>
                <div class="cell" data-board="3" data-cell="8"></div>
            </div>
        </div>
        <div class="game-cell">
            <div class="small-board" data-board="4">
                <div class="cell" data-board="4" data-cell="0"></div>
                <div class="cell" data-board="4" data-cell="1"></div>
                <div class="cell" data-board="4" data-cell="2"></div>
                <div class="cell" data-board="4" data-cell="3"></div>
                <div class="cell" data-board="4" data-cell="4"></div>
                <div class="cell" data-board="4" data-cell="5"></div>
                <div class="cell" data-board="4" data-cell="6"></div>
                <div class="cell" data-board="4" data-cell="7"></div>
                <div class="cell" data-board="4" data-cell="8"></div>
            </div>
        </div>
        <div class="game-cell">
            <div class="small-board" data-board="5">
                <div class="cell" data-board="5" data-cell="0"></div>
                <div class="cell" data-board="5" data-cell="1"></div>
                <div class="cell" data-board="5" data-cell="2"></div>
                <div class="cell" data-board="5" data-cell="3"></div>
                <div class="cell" data-board="5" data-cell="4"></div>
                <div class="cell" data-board="5" data-cell="5"></div>
                <div class="cell" data-board="5" data-cell="6"></div>
                <div class="cell" data-board="5" data-cell="7"></div>
                <div class="cell" data-board="5" data-cell="8"></div>
            </div>
        </div>
        <div class="game-cell">
            <div class="small-board" data-board="6">
                <div class="cell" data-board="6" data-cell="0"></div>
                <div class="cell" data-board="6" data-cell="1"></div>
                <div class="cell" data-board="6" data-cell="2"></div>
                <div class="cell" data-board="6" data-cell="3"></div>
                <div class="cell" data-board="6" data-cell="4"></div>
                <div class="cell" data-board="6" data-cell="5"></div>
                <div class="cell" data-board="6" data-cell="6"></div>
                <div class="cell" data-board="6" data-cell="7"></div>
                <div class="cell" data-board="6" data-cell="8"></div>
            </div>
        </div>
        <div class="game-cell">
            <div class="small-board" data-board="7">
                <div class="cell" data-board="7" data-cell="0"></div>
                <div class="cell" data-board="7" data-cell="1"></div>
                <div class="cell" data-board="7" data-cell="2"></div>
                <div class="cell" data-board="7" data-cell="3"></div>
                <div class="cell" data-board="7" data-cell="4"></div>
                <div class="cell" data-board="7" data-cell="5"></div>
                <div class="cell" data-board="7" data-cell="6"></div>
                <div class="cell" data-board="7" data-cell="7"></div>
                <div class="cell" data-board="7" data-cell="8"></div>
            </div>
        </div>
        <div class="game-cell">
            <div class="small-board" data-board="8">
                <div class="cell" data-board="8" data-cell="0"></div>
                <div class="cell" data-board="8" data-cell="1"></div>
                <div class="cell" data-board="8" data-cell="2"></div>
                <div class="cell" data-board="8" data-cell="3"></div>
                <div class="cell" data-board="8" data-cell="4"></div>
                <div class="cell" data-board="8" data-cell="5"></div>
                <div class="cell" data-board="8" data-cell="6"></div>
                <div class="cell" data-board="8" data-cell="7"></div>
                <div class="cell" data-board="8" data-cell="8"></div>
            </div>
        </div>
    </div>


    <script>
        // board state: 9 small boards, each is 3x3
        var boardState = [];
        for (let i = 0; i < 9; i++) {
            boardState[i] = [["","",""], ["","",""], ["","",""]];
        }
        
        // game: tracks which player won each small board
        var gameState = ["","","","","","","","",""];
        
        // Which board the current player must play in (null = any board)
        var activeBoard = null;
        var gameFinished = false;

        var gameBoard = document.getElementById("game-board");
        gameBoard.addEventListener('click', playerPlay);

        setTimeout(() => aiPlay(), 500);

        function playerPlay(ev){
            if (!ev.target.classList.contains('cell') || gameFinished) return;
            
            const boardIndex = parseInt(ev.target.dataset.board);
            const cellIndex = parseInt(ev.target.dataset.cell);
            const row = Math.floor(cellIndex / 3);
            const col = cellIndex % 3;
            
            // Check if cell is empty
            if (boardState[boardIndex][row][col] !== "") return;
            
            // Check if move is allowed (must play in activeBoard if specified)
            if (activeBoard !== null && activeBoard !== boardIndex) return;
            
            // Make the move
            boardState[boardIndex][row][col] = "X";
            ev.target.textContent = "X";
            
            // Check if this small board is won
            if (checkBoardWin(boardIndex, "X")) {
                gameState[boardIndex] = "X";
                document.querySelector(`.small-board[data-board="${boardIndex}"]`).style.opacity = "0.6";
            }
            
            // Check if game is won
            if (checkGameWin("X")) {
                gameFinished = true;
                setTimeout(() => alert("ðŸŽ‰ Player wins!"), 300);
                return;
            }
            
            // Set active board for opponent based on cell just played
            activeBoard = cellIndex;
            if (gameState[cellIndex] !== "") activeBoard = null; // If that board is won, can play anywhere
            
            setTimeout(() => aiPlay(), 1000);
        }

        function aiPlay(){
            if (gameFinished) return;
            
            var validMoves = getValidMoves();
            if (validMoves.length === 0) {
                alert("Draw!");
                return;
            }
            
            var bestScore = -1000;
            var bestMove;
            
            // Evaluate each valid move
            for (const move of validMoves) {
                const {boardIndex, cellIndex} = move;
                const row = Math.floor(cellIndex / 3);
                const col = cellIndex % 3;
                
                // Simulate move
                boardState[boardIndex][row][col] = "O";
                let score = evaluateMove(boardIndex);
                boardState[boardIndex][row][col] = "";
                
                if (score > bestScore) {
                    bestScore = score;
                    bestMove = move;
                }
            }
            
            if (!bestMove) return;
            
            const {boardIndex, cellIndex} = bestMove;
            const row = Math.floor(cellIndex / 3);
            const col = cellIndex % 3;
            
            // Make the move
            boardState[boardIndex][row][col] = "O";
            const cell = document.querySelector(`[data-board="${boardIndex}"][data-cell="${cellIndex}"]`);
            cell.textContent = "O";
            
            // Check if this small board is won
            if (checkBoardWin(boardIndex, "O")) {
                gameState[boardIndex] = "O";
                document.querySelector(`.small-board[data-board="${boardIndex}"]`).style.opacity = "0.6";
            }
            
            // Check if game is won
            if (checkGameWin("O")) {
                gameFinished = true;
                setTimeout(() => alert("AI wins!"), 300);
                return;
            }
            
            // Set active board for player
            activeBoard = cellIndex;
            if (gameState[cellIndex] !== "") activeBoard = null;
        }

        function evaluateMove(boardIndex) {
            let score = 0;
            
            // Can AI win the game?
            if (checkBoardWin(boardIndex, "O")) {
                gameState[boardIndex] = "O";
                if (checkGameWin("O")) score += 1000;
                gameState[boardIndex] = "";
            }
            
            // Can AI win this small board?
            if (checkBoardWin(boardIndex, "O")) score += 100;
            
            // Block player from winning small board
            if (checkBoardWin(boardIndex, "X")) score += 50;
            
            // Block player from winning game
            if (checkBoardWin(boardIndex, "X")) {
                gameState[boardIndex] = "X";
                if (checkGameWin("X")) score += 500;
                gameState[boardIndex] = "";
            }
            
            // Play in center or corners of small board
            const lastMove = Array.from(document.querySelectorAll(`[data-board="${boardIndex}"][data-cell]`))
                .findIndex(el => el.textContent === "");
            if ([4, 0, 2, 6, 8].includes(lastMove)) score += 5;
            
            return score;
        }

        function getValidMoves() {
            var moves = [];
            
            if (activeBoard === null) {
                // Can play in any board that isn't won
                for (let b = 0; b < 9; b++) {
                    if (gameState[b] !== "") continue;
                    for (let i = 0; i < 3; i++) {
                        for (let j = 0; j < 3; j++) {
                            if (boardState[b][i][j] === "") {
                                moves.push({boardIndex: b, cellIndex: i * 3 + j});
                            }
                        }
                    }
                }
            } else {
                // Must play in activeBoard if it's not won
                const b = activeBoard;
                if (gameState[b] === "") {
                    for (let i = 0; i < 3; i++) {
                        for (let j = 0; j < 3; j++) {
                            if (boardState[b][i][j] === "") {
                                moves.push({boardIndex: b, cellIndex: i * 3 + j});
                            }
                        }
                    }
                } else {
                    // Board is won, can play anywhere
                    for (let b = 0; b < 9; b++) {
                        if (gameState[b] !== "") continue;
                        for (let i = 0; i < 3; i++) {
                            for (let j = 0; j < 3; j++) {
                                if (boardState[b][i][j] === "") {
                                    moves.push({boardIndex: b, cellIndex: i * 3 + j});
                                }
                            }
                        }
                    }
                }
            }
            
            return moves;
        }

        function checkBoardWin(boardIndex, player) {
            const board = boardState[boardIndex];
            
            // Check rows and columns
            for (let i = 0; i < 3; i++) {
                if (board[i][0] === player && board[i][1] === player && board[i][2] === player) return true;
                if (board[0][i] === player && board[1][i] === player && board[2][i] === player) return true;
            }
            
            // Check diagonals
            if (board[0][0] === player && board[1][1] === player && board[2][2] === player) return true;
            if (board[0][2] === player && board[1][1] === player && board[2][0] === player) return true;
            
            return false;
        }

        function checkGameWin(player) {
            // Check rows
            for (let i = 0; i < 3; i++) {
                if (gameState[i*3] === player && gameState[i*3+1] === player && gameState[i*3+2] === player) return true;
            }
            
            // Check columns
            for (let i = 0; i < 3; i++) {
                if (gameState[i] === player && gameState[i+3] === player && gameState[i+6] === player) return true;
            }
            
            // Check diagonals
            if (gameState[0] === player && gameState[4] === player && gameState[8] === player) return true;
            if (gameState[2] === player && gameState[4] === player && gameState[6] === player) return true;
            
            return false;
        }

    </script>
</body>
</html>